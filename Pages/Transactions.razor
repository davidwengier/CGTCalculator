@page "/"
@page "/transactions"
@inject DataSource Data
@inject NavigationManager NavigationManager

@using Microsoft.AspNetCore.Components.QuickGrid
@using Microsoft.EntityFrameworkCore;

<Nav ShowHome="false" Title="Transactions" />

<button @onclick="Add_Click">Add Transaction</button>
<button @onclick="Import_Click">Import</button>

<div class="grid">
    <QuickGrid Items="_transactions" @ref="_grid">
        <PropertyColumn Property="t => t.Date" Format="dd MMM yyyy" Sortable="true" IsDefaultSort="SortDirection.Descending" />
        <PropertyColumn Property="t => t.Type" />
        <PropertyColumn Property="t => t.Symbol" />
        <TemplateColumn Title="@nameof(Field.Quantity)" Align="Align.Right">
            <span class="quantity @context.Type.ToString().ToLower()">@context.Quantity.ToString("0.####")</span>
        </TemplateColumn>
        <TemplateColumn Title="@nameof(Field.Value)" Align="Align.Right">
            <span class="money @context.Type.ToString().ToLower()">@context.Value.ToString("$#,##0.00")</span>
        </TemplateColumn>
        <TemplateColumn>
            <button @onclick="() => Edit_Click(context)">Edit</button>
            <button @onclick="() => Delete_Click(context)">Delete</button>
        </TemplateColumn>
    </QuickGrid>
</div>

@code
{
    private QuickGrid<Transaction> _grid = null!;
    private IQueryable<Transaction>? _transactions;

    protected override Task OnInitializedAsync()
    {
        _transactions = Data.Transactions;

        return Task.CompletedTask;
    }

    private void Add_Click()
    {
        NavigationManager.NavigateTo("/add");
    }

    private void Import_Click()
    {
        NavigationManager.NavigateTo("/import");
    }

    private void Edit_Click(Transaction transaction)
    {
        NavigationManager.NavigateTo($"/edit/{transaction.Id}");
    }

    private async Task Delete_Click(Transaction transaction)
    {
        if (MessageBox.Show($"Are you sure to wish to delete this {transaction.Type} of {transaction.Symbol} for {transaction.Value:$#,##0.00}?", "Are you sure?", MessageBoxButtons.YesNo) == DialogResult.Yes)
        {
            Data.Remove(transaction);
            await Data.SaveChangesAsync();
            await _grid.RefreshDataAsync().ConfigureAwait(false);
        }
    }
}